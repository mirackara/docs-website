---
title: Diagnose slow database queries
metaDescription: Improve query performance by troubleshooting your slow database with the New Relic Database UI.
redirects:
---

import apmDefaultDatabaseUI from 'images/apm_screenshot-full_default-database-UI.png'

import apmATimesliceChartofTop5DatabaseOperations from 'images/apm_screenshot-crop_A-timeslice-chart-of-top-5-database-operations.png'

import apmTopDatabasesbyQueryTime from 'images/apm_screenshot-crop_Top-databases-by-query-time.png'

import apmDatabaseThroughput from 'images/apm_screenshot-crop_Database-throughput.png'

import apmDiggingDeeperIntoYourDatabase from 'images/apm_screenshot-full_Digging-deeper-into-your-database.gif'

When your site is disrupted, your customers are left waiting while you troubleshoot a problem that's as complex as your system. Your data's reporting and you have a rough idea of what could be the problem, but where do you start? 

If your site relies on a database (and it probably does), you'll want to check that query response time is performing as expected. Often, the performance of your site depends on how well your database handles queries sent by your customers. With New Relic, you can use our database UI to track database performance over time, letting you pinpoint when a problem occurred so you can figure out what kind of solution you need. 

This tutorial explains how to troubleshoot slow queries in your database operations.  

## Scope out the problem with your app data  [#diagnose]

Our database UI displays charts built with NRQL queries, creating timeslice data from the `apm.service.datastore.operation.duration` metric. These charts show the response time of your top database processes by the top operations, their query time, and your app's throughput. 

When you're scoping out a problem, we recommend using each of these different entry points as they tell different parts of the same story. Let's walk through how you might use the UI to begin diagnosing performance issues. 

<img
  title="Default database homepage"
  alt="Default database homepage"
  src={apmDefaultDatabaseUI}
/>

<figcaption>
  To begin troubleshooting your slowest queries, you'll start on APM's default database UI. 
</figcaption>

<Steps>
<Step>

  ### Time consumed by database operations

  The **Most time consuming** chart shows the total processing time on queries by a database operation. 

<SideBySide>
  <Side>

    ```sql
    SELECT sum(apm.service.datastore.operation.duration * 1000) FROM Metric WHERE (entity.guid = YOUR_ENTITY_GUID) FACET `datastoreType`, `table`, `operation` LIMIT 5 SINCE 1800 seconds AGO TIMESERIES```

  </Side>

  <Side>
<img
  title="Top 5 Database operations over time"
  alt=""
  src={apmATimesliceChartofTop5DatabaseOperations}
/>

<figcaption>
  The database UI shows graphs of your database operations over time.
</figcaption> 

</Side>
</SideBySide>

  This NRQL query creates a chart that displays 5 database operations, then tracks their time to execute a query. This chart shows your busiest, most frequently called queries at the top. If an infrequently called query trends with your busiest queries, however, it may indicate a problem with a query that needs further scoping. 
    
</Step>

<Step>

### Top databases by query time

The **Top databases by query time** chart shows how your databases are performing based on how long it takes to execute a query. 

<SideBySide>
  <Side>
      ```sql
    SELECT average(apm.service.datastore.operation.duration * 1000) FROM Metric WHERE (entity.guid = YOUR_ENTITY_GUID) FACET `datastoreType`, `table`, `operation` LIMIT 5 SINCE 1800 seconds AGO TIMESERIES```
  </Side>

  <Side>
    <img
  title="Top databases by query time"
  alt=""
  src={apmTopDatabasesbyQueryTime}
/>

<figcaption>
  The database UI shows you graphs of your top databases by query time.
</figcaption>
  </Side>

</SideBySide>

  This NRQL query creates a chart that displays top databases, then averages how long queries take. For example, if, on average, your Redis EVAL database averages about a half-second to process a query, but query time increased by 2 seconds, then you know to dig deeper into individual queries. 

</Step>

<Step>

### Top databases by throughput

The **Top databases by throughput** chart shows your database throughput over time. 

<SideBySide>
  <Side>
```sql
SELECT rate(count(apm.service.datastore.operation.duration), 1 minute) FROM Metric WHERE (entity.guid = YOUR_ENTITY_GUID) LIMIT 5 SINCE 1800 seconds AGO TIMESERIES  facet concat(datastoreType, ' ', table, ' ', operation)```  
</Side>
  <Side>
    <img
  title="Top 5 Database operations over time"
  alt=""
  src={apmDatabaseThroughput}
/>

<figcaption>
  The database UI shows you graphs of your top databases by throughput.
</figcaption>
  </Side>
</SideBySide>

The throughput graphs tracks the number of processes an operation executes in a given time range. If your throughput tanks, you know to dig deeper into a particular operation. 

</Step>
</Steps>

## Digging deeper into your database queries [#fix]

Digging deeper means following the data. Identifying the approximate area where a problem exists is only part of finding a solution. 

After looking at how your database performs on average, your next step is to follow the data with query time, transactions, and stack traces.

<CollapserGroup>
  <Collapser
    className="freq-link"
    id="compare-averages"
    title="Compare query time and throughput averages to a time window"
  >

  You've noticed a particular operation is accounting for an abnormally large part of your database operations. To dig deeper, you'd click the operation from the **Top 20 database operations** side pane, which opens up a new window that displays data relevant to that particular database operation.

  Let's look at what this page tells us about `Redis HMGET`:  

  <img
  title="Database UI operations view"
  alt=""
  src={apmDiggingDeeperIntoYourDatabase}
/>

This page displays information about query time and throughput, then tracks that data over time with their accompanying timeslice charts. Underneath that, you can find a pie chart of database operation callers, which shows the time consumed by individual callers. 

For `Redis HMGET`, the `hipstershop.CartService/GetCart` caller is using a lot of time. Maybe this is the source of your problem, or maybe it's an area you can further optimize to improve overall performance. Either way, you've dug deeper and are ready to work on the resolution. 

</Collapser>
<Collapser
    className="freq-link"
    id="break-down"
    title="Scope out the transaction calling your database"
  >
NEED PROCEDURES  
</Collapser>
  <Collapser
    className="freq-link"
    id="bottlenecks"
    title="Find bottlenecks via a stack trace"
  >
NEED PROCEDURES
  </Collapser>
</CollapserGroup>

<DocTiles numbered>
  <DocTile title='Prepare to triage your application' path="/docs/journey-app-slow/root-causes" label={{text: "Tutorial", color: "green"}}>Start by setting up observability for your application</DocTile>
  <DocTile title='Identify problematic transactions' path="/docs/journey-app-slow/problematic-transactions" label={{text: "Tutorial", color: "green"}}>Next, identify and optimize problematic transactions within your code  </DocTile>
</DocTiles>

<DocTiles>
  <DocTile title='Identify slow database queries' number='3' path="/docs/journey-app-slow/slow-database-queries" label={{text: "Tutorial", color: "green"}}>Continue seeking out and fixing slow database queries</DocTile>
  <DocTile title='Identify slow external services' number='4' path="/docs/journey-app-slow/external-services" label={{text: "Tutorial", color: "green"}}>Then, diagnose and optimize slow external services </DocTile>
  <DocTile title='Create performance benchamarks' number='5' path="/docs/journey-app-slow/create-benchmarks/" label={{text: "Tutorial", color: "green"}}>Finish up by creating performance benchmarks so you can respond if your app ever slows down again!</DocTile>
</DocTiles>